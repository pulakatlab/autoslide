name: Test Pipeline

on:
  pull_request:
  workflow_dispatch:

jobs:
  test-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1 libglib2.0-0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -e .
    
    - name: Install Git LFS and pull models
      run: |
        git lfs install
        git lfs pull
    
    - name: Download test data
      id: download
      run: |
        python pipeline_testing/prefect_pipeline.py --download_test_data --skip_annotation --skip_training --verbose
      continue-on-error: true
    
    - name: Run pipeline with auto-labeling
      id: pipeline
      run: |
        # Find the downloaded SVS file
        SVS_FILE=$(find test_data -name "*.svs" -type f | head -1)
        if [ -z "$SVS_FILE" ]; then
          echo "No SVS file found, skipping pipeline"
          exit 0
        fi
        echo "Using SVS file: $SVS_FILE"
        python pipeline_testing/prefect_pipeline.py \
          --test_data "$SVS_FILE" \
          --auto_label \
          --skip_training \
          --verbose
      continue-on-error: true
    
    - name: Check available models
      id: check_models
      run: |
        echo "Checking for available models..."
        MASKRCNN_MODEL="autoslide/artifacts/best_val_mask_rcnn_model.pth"
        UNET_MODEL="autoslide/artifacts/best_val_unet_model.pth"
        
        MODELS_FOUND=0
        if [ -f "$MASKRCNN_MODEL" ]; then
          echo "✅ Mask R-CNN model found"
          echo "has_maskrcnn=true" >> $GITHUB_OUTPUT
          MODELS_FOUND=$((MODELS_FOUND + 1))
        else
          echo "❌ Mask R-CNN model not found"
          echo "has_maskrcnn=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "$UNET_MODEL" ]; then
          echo "✅ UNet model found"
          echo "has_unet=true" >> $GITHUB_OUTPUT
          MODELS_FOUND=$((MODELS_FOUND + 1))
        else
          echo "❌ UNet model not found"
          echo "has_unet=false" >> $GITHUB_OUTPUT
        fi
        
        echo "models_found=$MODELS_FOUND" >> $GITHUB_OUTPUT
        
        if [ $MODELS_FOUND -eq 0 ]; then
          echo "❌ No models found! At least one model must be present."
          exit 1
        fi
    
    - name: Run prediction with Mask R-CNN
      id: prediction_maskrcnn
      if: steps.check_models.outputs.has_maskrcnn == 'true'
      run: |
        echo "Running prediction with Mask R-CNN..."
        python autoslide/src/pipeline/model/prediction.py --model-type maskrcnn --verbose
      continue-on-error: false
    
    - name: Run prediction with UNet
      id: prediction_unet
      if: steps.check_models.outputs.has_unet == 'true'
      run: |
        echo "Running prediction with UNet..."
        # Clear previous predictions if Mask R-CNN ran
        if [ "${{ steps.check_models.outputs.has_maskrcnn }}" == "true" ]; then
          echo "Clearing previous predictions..."
          find test_data/suggested_regions -type d -name "masks" -exec rm -rf {} + 2>/dev/null || true
          find test_data/suggested_regions -type d -name "overlays" -exec rm -rf {} + 2>/dev/null || true
        fi
        python autoslide/src/pipeline/model/prediction.py --model-type unet --verbose
      continue-on-error: false
    
    - name: Calculate fibrosis
      id: fibrosis
      run: |
        python autoslide/src/fibrosis_calculation/calc_fibrosis.py --verbose
      continue-on-error: true
    
    - name: Generate test summary
      if: always()
      run: |
        echo "## Pipeline Test Results" > test_summary.md
        echo "" >> test_summary.md
        
        # Check what was generated
        if [ -d "test_data/initial_annotation" ]; then
          echo "✅ Initial annotation completed" >> test_summary.md
          echo "- Files: $(ls test_data/initial_annotation | wc -l)" >> test_summary.md
        else
          echo "❌ Initial annotation failed" >> test_summary.md
        fi
        
        if [ -d "test_data/final_annotation" ]; then
          echo "✅ Final annotation completed" >> test_summary.md
          echo "- Files: $(ls test_data/final_annotation | wc -l)" >> test_summary.md
        else
          echo "❌ Final annotation failed" >> test_summary.md
        fi
        
        if [ -d "test_data/suggested_regions" ]; then
          echo "✅ Region suggestion completed" >> test_summary.md
          IMAGES=$(find test_data/suggested_regions -name "*.png" -path "*/images/*" | wc -l)
          echo "- Heart tissue sections: $IMAGES" >> test_summary.md
        else
          echo "❌ Region suggestion failed" >> test_summary.md
        fi
        
        # Check prediction results
        echo "" >> test_summary.md
        echo "### Prediction Results" >> test_summary.md
        
        if [ "${{ steps.check_models.outputs.has_maskrcnn }}" == "true" ]; then
          if [ "${{ steps.prediction_maskrcnn.outcome }}" == "success" ]; then
            echo "✅ Mask R-CNN prediction completed" >> test_summary.md
          else
            echo "❌ Mask R-CNN prediction failed" >> test_summary.md
          fi
        else
          echo "⚠️  Mask R-CNN model not available" >> test_summary.md
        fi
        
        if [ "${{ steps.check_models.outputs.has_unet }}" == "true" ]; then
          if [ "${{ steps.prediction_unet.outcome }}" == "success" ]; then
            echo "✅ UNet prediction completed" >> test_summary.md
          else
            echo "❌ UNet prediction failed" >> test_summary.md
          fi
        else
          echo "⚠️  UNet model not available" >> test_summary.md
        fi
        
        if [ -d "test_data/suggested_regions" ] && [ -d "$(find test_data/suggested_regions -name masks -type d | head -1)" ]; then
          MASKS=$(find test_data/suggested_regions -name "*_mask.png" | wc -l)
          echo "- Total prediction masks: $MASKS" >> test_summary.md
        fi
        
        if [ -f "test_data/fibrosis_results/summary_statistics.json" ]; then
          echo "✅ Fibrosis calculation completed" >> test_summary.md
          echo "- Results:" >> test_summary.md
          cat test_data/fibrosis_results/summary_statistics.json | python -m json.tool | grep -E "(mean|total)" >> test_summary.md
        else
          echo "❌ Fibrosis calculation failed" >> test_summary.md
        fi
        
        cat test_summary.md
    
    - name: Upload test summary
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: test_summary.md
        retention-days: 30
    
    - name: Upload initial annotation results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: initial-annotation
        path: |
          test_data/initial_annotation/*.png
          test_data/initial_annotation/*.csv
          test_data/tracking/*.json
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload final annotation results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: final-annotation
        path: |
          test_data/final_annotation/*.png
          test_data/final_annotation/*.npy
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload region suggestions
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: region-suggestions
        path: |
          test_data/suggested_regions/**/images/*.png
          test_data/suggested_regions/**/*_section_frame.csv
          test_data/suggested_regions/**/*_visualization.png
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload prediction results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: prediction-results
        path: |
          test_data/suggested_regions/**/masks/*_mask.png
          test_data/suggested_regions/**/overlays/*_overlay.png
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload fibrosis results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fibrosis-results
        path: |
          test_data/fibrosis_results/*.csv
          test_data/fibrosis_results/*.json
          test_data/fibrosis_results/*.png
          test_data/fibrosis_results/visualizations/*.png
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload complete test data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: complete-test-data
        path: |
          test_data/**/*
          !test_data/**/*.svs
          !test_data/**/*.npy
        retention-days: 7
        if-no-files-found: warn
    
    - name: Check pipeline status and fail if any step failed
      if: always()
      run: |
        echo "Checking pipeline step results..."
        FAILED=0
        
        if [ "${{ steps.download.outcome }}" == "failure" ]; then
          echo "❌ Download test data failed"
          FAILED=1
        else
          echo "✅ Download test data succeeded"
        fi
        
        if [ "${{ steps.pipeline.outcome }}" == "failure" ]; then
          echo "❌ Pipeline with auto-labeling failed"
          FAILED=1
        else
          echo "✅ Pipeline with auto-labeling succeeded"
        fi
        
        # Check prediction outcomes
        PREDICTION_FAILED=0
        if [ "${{ steps.check_models.outcome }}" == "failure" ]; then
          echo "❌ Model check failed (no models found)"
          FAILED=1
          PREDICTION_FAILED=1
        fi
        
        if [ "${{ steps.check_models.outputs.has_maskrcnn }}" == "true" ]; then
          if [ "${{ steps.prediction_maskrcnn.outcome }}" == "failure" ]; then
            echo "❌ Mask R-CNN prediction failed"
            FAILED=1
            PREDICTION_FAILED=1
          else
            echo "✅ Mask R-CNN prediction succeeded"
          fi
        else
          echo "⚠️  Mask R-CNN model not available (skipped)"
        fi
        
        if [ "${{ steps.check_models.outputs.has_unet }}" == "true" ]; then
          if [ "${{ steps.prediction_unet.outcome }}" == "failure" ]; then
            echo "❌ UNet prediction failed"
            FAILED=1
            PREDICTION_FAILED=1
          else
            echo "✅ UNet prediction succeeded"
          fi
        else
          echo "⚠️  UNet model not available (skipped)"
        fi
        
        if [ $PREDICTION_FAILED -eq 0 ] && [ "${{ steps.check_models.outputs.models_found }}" -gt 0 ]; then
          echo "✅ All available model predictions succeeded"
        fi
        
        if [ "${{ steps.fibrosis.outcome }}" == "failure" ]; then
          echo "❌ Fibrosis calculation failed"
          FAILED=1
        else
          echo "✅ Fibrosis calculation succeeded"
        fi
        
        if [ $FAILED -eq 1 ]; then
          echo ""
          echo "❌ One or more pipeline steps failed. Failing workflow."
          exit 1
        else
          echo ""
          echo "✅ All pipeline steps succeeded!"
        fi
